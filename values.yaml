## Jenkins Controller
controller:
  jenkinsUrl: "http://jenkins.jenkins.svc.cluster.local:8080"
  image:
    registry: docker.io
    repository: jenkins/jenkins
    tag: 2.541.1-lts-jdk21
    pullPolicy: IfNotPresent
  serviceType: ClusterIP

  ## IMPORTANT: disable inbound TCP agents correctly
  agentListenerEnabled: false

  admin:
    existingSecret: jenkins-admin-credentials
    userKey: jenkins-admin-user
    passwordKey: jenkins-admin-password

  ## Mount the dockerhub secret into Jenkins
  additionalExistingSecrets:
    - name: dockerhub-creds
      keyName: username
    - name: dockerhub-creds
      keyName: password
    - name: github-creds
      keyName: username
    - name: github-creds
      keyName: password

  resources:
    requests:
      cpu: "1000m"
      memory: "2Gi"
    limits:
      cpu: "2"
      memory: "4Gi"

  persistence:
    enabled: true
    size: 10Gi

  runAsUser: 1000
  fsGroup: 1000

  installPluginsTimeout: 20
  installPlugins:
    - kubernetes
    - workflow-aggregator
    - git
    - configuration-as-code
    - credentials
    - blueocean
    - job-dsl
    - github
    - pipeline-stage-view
    - role-strategy
    - audit-trail
    - antisamy-markup-formatter

  startupProbe:
    httpGet:
      path: /login
      port: 8080
    failureThreshold: 60
    periodSeconds: 10

  livenessProbe:
    httpGet:
      path: /login
      port: 8080
    initialDelaySeconds: 180
    periodSeconds: 30
    failureThreshold: 10
    timeoutSeconds: 5

  readinessProbe:
    httpGet:
      path: /login
      port: 8080
    initialDelaySeconds: 60
    periodSeconds: 15
    failureThreshold: 10
    timeoutSeconds: 5


  ## Jenkins Configuration as Code
  JCasC:
    enabled: true
    defaultConfig: false   # <<< THIS IS THE CRITICAL LINE
    configScripts:
      kubernetes-cloud.yaml: |
        jenkins:
          clouds:
            - kubernetes:
                name: "kubernetes"
                namespace: "jenkins-agents"
                jenkinsUrl: "http://jenkins.jenkins.svc.cluster.local:8080"
                webSocket: true
                containerCap: 10
                waitForPodSec: 120
                podRetention: never
                templates:
                  - name: "buildkit-agent"
                    namespace: "jenkins-agents"
                    serviceAccount: "jenkins"
                    idleMinutes: 0.5
                    volumes:
                      - emptyDirVolume:
                          mountPath: "/run/buildkit"
                      - emptyDirVolume:
                          mountPath: "/home/jenkins/agent"
                    containers:
                      - name: "jnlp"
                        image: "jenkins/inbound-agent:3256.v88a_f6e922152-1-jdk21"
                        workingDir: "/home/jenkins/agent"
                        resourceRequestCpu: "250m"
                        resourceRequestMemory: "256Mi"
                        resourceLimitCpu: "500m"
                        resourceLimitMemory: "512Mi"
                      - name: "buildkitd"
                        image: "moby/buildkit:v0.19.0"
                        privileged: true
                        args: "--addr unix:///run/buildkit/buildkitd.sock"
                        resourceRequestCpu: "500m"
                        resourceRequestMemory: "512Mi"
                        resourceLimitCpu: "2"
                        resourceLimitMemory: "2Gi"
                      - name: "buildctl"
                        image: "moby/buildkit:v0.19.0"
                        command: "sleep"
                        args: "infinity"
                        workingDir: "/home/jenkins/agent"
                        resourceRequestCpu: "250m"
                        resourceRequestMemory: "256Mi"
                        resourceLimitCpu: "1"
                        resourceLimitMemory: "1Gi"

      security.yaml: |
        jenkins:
          securityRealm:
            local:
              allowsSignup: false
          authorizationStrategy:
            loggedInUsersCanDoAnything:
              allowAnonymousRead: false
        security:
          apiToken:
            creationOfLegacyTokenEnabled: false
            tokenGenerationOnCreationEnabled: false
            usageStatisticsEnabled: true

      credentials.yaml: |
        credentials:
          system:
            domainCredentials:
              - credentials:
                  - usernamePassword:
                      scope: GLOBAL
                      id: "dockerhub-creds"
                      username: ${dockerhub-creds-username}
                      password: ${dockerhub-creds-password}
                      description: "Docker Hub credentials"
                  - usernamePassword:
                      scope: GLOBAL
                      id: "github-creds"
                      username: ${github-creds-username}
                      password: ${github-creds-password}
                      description: "GitHub credentials"

      jobs.yaml: |
        jobs:
          - script: >
              pipelineJob('ci-dashboard') {
                properties {
                  disableConcurrentBuilds()
                }
                triggers {
                  githubPush()
                }
                definition {
                  cpsScm {
                    scm {
                      git {
                        remote {
                          url('https://github.com/sagi-l/ci-dashboard.git')
                        }
                        branch('main')
                        extensions {
                          messageExclusion {
                            excludedMessage('.*\\[skip ci\\].*')
                          }
                        }
                      }
                    }
                    scriptPath('Jenkinsfile')
                  }
                }
              }

## Helm-managed agents â€” DISABLED
agent:
  enabled: false

## RBAC & Service Account
rbac:
  create: true

serviceAccount:
  create: true
